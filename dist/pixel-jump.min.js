function Game(a,b){if(Game._this)return Game._this;Game._this=this,void 0===b&&(b={}),this.gameHeight=parseInt(b.canvasHeight)>0?parseInt(b.canvasHeight):480,this.gameWidth=parseInt(b.canvasWidth)>0?parseInt(b.canvasWidth):320,this.canvas=document.getElementById(a),this.canvas.width=this.gameWidth,this.canvas.height=this.gameHeight,this.ctx=this.canvas.getContext("2d"),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.gameSpeed=120,this.score=0,this.bestScore=0,this.player,this.world,this.state,this.playerColor,this.worldColor,this.backgroundColor,this.titleColor,this.textColor,this.then,this.now,this.dt,this.requestId,this.pause=!1,this.gameKey,this.pauseKey,this.key=null,this.keyDone=!1,this.GAME_STATE=Game.GAME_STATE,this.init(b)}function World(a){this.width=a.gameWidth,this.height=a.gameHeight,this.groundHeight=20,this.color,this.gapHeight=120,this.gapWidth=50,this.gapSpace=230,this.gapSpeed=a.gameSpeed,this.gapNumber=Math.ceil(this.width/this.gapSpace)+1,this.gapList=new Array(this.gapNumber),this.reset()}function Gap(a,b,c){this.width=c.gapWidth,this.height=c.gapHeight,this.used=!1,this.posX=a,this.posY=b,this.maxY=c.height,this.speedX=c.gapSpeed,this.color=c.color,this.topSize=this.posY-this.height/2,this.bottomSize=this.maxY-(this.posY+this.height/2)}function Player(a){this.width=30,this.height=30,this.posX=a.gameWidth/2,this.posY=a.gameHeight/2,this.maxY=a.gameHeight,this.speedY=0,this.speedX=a.gameSpeed,this.gravity=-1e3,this.playing=!1,this.dying=!1,this.dead=!1,this.trailSize=.7*this.posX,this.trail=new Array(this.trailSize),this.trail.fill([this.posX,this.posY]),this.color=a.playerColor,this.colorHsl,this.particles=new Array(100)}function Particle(a,b,c){this.x=a,this.y=b,this.dx=200*Math.random()-100,this.dy=200*Math.random()-100,this.color=c,this.size=6+5*Math.random(),this.active=!0,this.update=function(a){this.x+=this.dx*a,this.y+=this.dy*a,this.size-=7*a,this.size<.4&&(this.active=!1)},this.draw=function(a){a.fillStyle=this.color,a.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size)}}WebFontConfig={google:{families:["Racing+Sans+One","Nova+Square"]}},function(){var a=document.createElement("script");a.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js",a.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(a)}();var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame}();Game.GAME_STATE={INTRO:"INTRO",GAME:"GAME",SCORE:"SCORE"},Game.prototype.init=function(a){this.state=this.GAME_STATE.INTRO,this.player=new Player(this),this.world=new World(this),this.setColor(a.playerColor,a.worldColor,a.backgroundColor,a.textColor),this.setSize(a.width,a.height,a.border),this.gameKey=" ",this.pauseKey="p",this.setListener(),this.then=Date.now(),this.mainLoop()},Game.prototype.setListener=function(){window.addEventListener("keydown",function(a){Game._this.key=a.key},!1),window.addEventListener("keyup",function(a){Game._this.key=null,Game._this.keyDone=!1},!1),window.addEventListener("keydown",function(a){a.key==Game._this.pauseKey&&Game._this.togglePause()},!1)},Game.prototype.mainLoop=function(){Game._this.now=Date.now(),Game._this.dt=(Game._this.now-Game._this.then)/1e3,Game._this.update(),Game._this.draw(),Game._this.then=Game._this.now,Game._this.requestId=requestAnimFrame(Game._this.mainLoop)},Game.prototype.update=function(){this.keydownHandler(),this.player.update(Game._this.dt),this.state==this.GAME_STATE.GAME&&(this.player.posY+this.player.height/2>this.gameHeight-this.world.groundHeight&&this.gameover(),this.world.gapList.forEach(function(a,b){a.update(Game._this.dt),a.collideWith(Game._this.player)&&Game._this.gameover(),a.posX+a.width/2<Game._this.player.posX-Game._this.player.width/2&&!a.used&&(a.used=!0,Game._this.score++),a.posX+a.width/2<0&&Game._this.world.refreshGap(b)}))},Game.prototype.draw=function(){this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this.gameWidth,this.gameHeight),this.state==this.GAME_STATE.INTRO?(this.world.render(this.ctx),this.player.render(this.ctx),this.ctx.strokeWidth=1,this.ctx.strokeStyle=this.backgroundColor,this.ctx.font="40pt Racing Sans One",this.ctx.fillStyle=this.titleColor,this.ctx.strokeText("Pixel Jump",this.gameWidth/2,this.gameHeight/4),this.ctx.fillText("Pixel Jump",this.gameWidth/2,this.gameHeight/4),this.ctx.font="20pt Nova Square",this.ctx.fillStyle=this.textColor,this.ctx.strokeText("- SPACE -",this.gameWidth/2,3*this.gameHeight/4),this.ctx.fillText("- SPACE -",this.gameWidth/2,3*this.gameHeight/4)):this.state==this.GAME_STATE.SCORE?(this.world.render(this.ctx),this.player.render(this.ctx),this.ctx.strokeWidth=1,this.ctx.strokeStyle=this.backgroundColor,this.ctx.fillStyle=this.textColor,this.ctx.font="40pt Nova Square",this.ctx.strokeText("Game Over",this.gameWidth/2,this.gameHeight/4),this.ctx.fillText("Game Over",this.gameWidth/2,this.gameHeight/4),this.ctx.font="30pt Nova Square",this.ctx.strokeText("Score: "+String(this.score),this.gameWidth/2,this.gameHeight/2),this.ctx.fillText("Score: "+String(this.score),this.gameWidth/2,this.gameHeight/2),this.ctx.font="25pt Nova Square",this.ctx.strokeText("Best: "+String(this.bestScore),this.gameWidth/2,this.gameHeight/2+40),this.ctx.fillText("Best: "+String(this.bestScore),this.gameWidth/2,this.gameHeight/2+40),this.player.dead&&(this.ctx.font="20pt Nova Square",this.ctx.strokeText("- SPACE -",this.gameWidth/2,3*this.gameHeight/4),this.ctx.fillText("- SPACE -",this.gameWidth/2,3*this.gameHeight/4))):(this.world.render(this.ctx),this.player.render(this.ctx),this.ctx.strokeWidth=1,this.ctx.strokeStyle=this.backgroundColor,this.ctx.fillStyle=this.textColor,this.ctx.font="50pt Nova Square",this.ctx.strokeText(String(this.score),this.gameWidth/2,50),this.ctx.fillText(String(this.score),this.gameWidth/2,50))},Game.prototype.keydownHandler=function(){if(this.key==this.gameKey&&!this.keyDone)if(this.keyDone=!0,this.state==this.GAME_STATE.INTRO)this.state=this.GAME_STATE.GAME,this.score=0,this.player.playing=!0,this.player.jump();else if(this.state==this.GAME_STATE.GAME)this.player.jump();else if(this.state==this.GAME_STATE.SCORE&&this.player.dead&&(this.player.reset(this.gameWidth/2,this.gameHeight/2),this.world.reset(),this.state=this.GAME_STATE.INTRO,-1==this.playerColor)){var a=this.player.newColor();this.titleColor="hsl("+(a+45)%360+",100%,50%)"}},Game.prototype.togglePause=function(){this.pause=!this.pause,this.pause?cancelAnimFrame(this.requestId):(this.then=Date.now(),this.requestId=requestAnimFrame(this.mainLoop))},Game.prototype.gameover=function(){this.state=this.GAME_STATE.SCORE,this.player.die();var a=!1;"undefined"!=typeof localStorage&&(a=!0,null!=localStorage.getItem("pixelJumpBestScore")&&(this.bestScore=parseInt(localStorage.getItem("pixelJumpBestScore")))),this.score>this.bestScore&&(this.bestScore=this.score,a&&localStorage.setItem("pixelJumpBestScore",String(this.bestScore)))},Game.prototype.setSize=function(a,b,c){var d,e,a=parseInt(a),b=parseInt(b);if(b>0&&a>0)d=b,e=a;else if(b>0)d=b,e=d*this.gameWidth/this.gameHeight;else if(a>0)e=a,d=e*this.gameHeight/this.gameWidth;else{var f=this.canvas.parentElement.clientWidth,g=this.canvas.parentElement.clientHeight,h=window.getComputedStyle(this.canvas.parentElement,null);g-=parseFloat(h.paddingTop)+parseFloat(h.paddingBottom),f-=parseFloat(h.paddingLeft)+parseFloat(h.paddingRight),f/g>this.gameWidth/this.gameHeight?(d=g,e=d*this.gameWidth/this.gameHeight):(e=f,d=e*this.gameHeight/this.gameWidth)}("boolean"!=typeof c||c)&&(this.canvas.style.border="5px solid "+this.worldColor,d-=10,e-=10),this.canvas.style.height=String(d)+"px",this.canvas.style.width=String(e)+"px"},Game.prototype.setColor=function(a,b,c,d){if(this.playerColor="string"==typeof a&&7==a.length?a:-1,this.worldColor="string"==typeof b&&7==b.length?b:"#c1c0bf",this.backgroundColor="string"==typeof c&&7==c.length?c:"#31302b",this.textColor="string"==typeof d&&7==d.length?d:"#ffffff",this.world.color=this.worldColor,-1==this.playerColor){var e=this.player.newColor();this.titleColor="hsl("+(e+45)%360+",100%,50%)"}else this.player.color=this.playerColor,this.titleColor=this.worldColor},World.prototype.reset=function(){for(var b,a=this.width+this.gapSpace,c=0;c<this.gapList.length;c++)b=Math.floor(Math.random()*(this.height-2*this.gapHeight-this.groundHeight)+this.gapHeight),this.gapList[c]=new Gap(a,b,this),a+=this.gapSpace},World.prototype.render=function(a){a.fillStyle=this.color,a.fillRect(0,this.height,this.width,-this.groundHeight),this.gapList.forEach(function(b){b.render(a)})},World.prototype.refreshGap=function(a){var b=0==a?this.gapNumber-1:a-1,c=this.gapList[b].posX+this.gapSpace,d=Math.floor(Math.random()*(this.height-200)+100);this.gapList[a].reset(c,d)},Gap.prototype.update=function(a,b){this.posX=this.posX-this.speedX*a},Gap.prototype.render=function(a){a.fillStyle=this.color,a.fillRect(this.posX-this.width/2,0,this.width,this.topSize),a.fillRect(this.posX-this.width/2,this.posY+this.height/2,this.width,this.bottomSize)},Gap.prototype.reset=function(a,b){this.used=!1,this.posX=a,this.posY=b,this.topSize=this.posY-this.height/2,this.bottomSize=this.maxY-(this.posY+this.height/2)},Gap.prototype.collideWith=function(a){return!(a.posX+a.width/2<this.posX-this.width/2||a.posX-a.width/2>this.posX+this.width/2)&&!(a.posY-a.height/2>this.posY-this.height/2&&a.posY+a.height/2<this.posY+this.height/2)},Player.prototype.update=function(a){if(this.playing&&!this.dying&&(this.posY=this.posY+this.speedY*a,this.speedY=this.speedY-this.gravity*a),!this.dying){for(var b=0;b<this.trailSize-1;b++)this.trail[b]=this.trail[b+1],this.trail[b][0]-=this.speedX*a;this.trail[this.trailSize-1]=[this.posX,this.posY]}if(this.dying){var c=0;this.particles.forEach(function(b){b.active&&(b.update(a),c++)}),0==c&&(this.dead=!0)}},Player.prototype.render=function(a){a.strokeStyle=this.color,a.lineWidth=5,a.lineJoin="round",a.lineCap="round",a.beginPath(),a.moveTo(this.trail[0][0],this.trail[0][1]);for(var b=1;b<this.trailSize;b++)a.lineTo(this.trail[b][0],this.trail[b][1]);if(a.stroke(),this.dying||(a.fillStyle=this.color,a.fillRect(this.posX-this.width/2,this.posY-this.height/2,this.width,this.height)),this.dying&&!this.dead)for(var b=0;b<this.particles.length;b++)this.particles[b].active&&this.particles[b].draw(a)},Player.prototype.jump=function(){this.posY>0&&(this.speedY=-350)},Player.prototype.reset=function(a,b){this.speedY=0,this.playing=!1,this.dying=!1,this.dead=!1,this.posX=a,this.posY=b,this.trail.fill([this.posX,this.posY])},Player.prototype.die=function(){this.dying=!0,this.dead=!1;for(var a,b,c=0;c<this.particles.length;c++)7==this.color.length?a=this.color:(b=(this.colorHsl-20+Math.round(40*Math.random()))%360,a="hsl("+b+",100%,50%)"),this.particles[c]=new Particle(this.posX,this.posY,a)},Player.prototype.newColor=function(){var a=Math.floor(360*Math.random());return this.color="hsl("+a+",100%,50%)",this.colorHsl=a,a};
